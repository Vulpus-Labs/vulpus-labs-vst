name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-windows:
    name: Build Windows CLAP and VST3
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Checkout VST3 SDK
      uses: actions/checkout@v4
      with:
        repository: steinbergmedia/vst3sdk
        path: vst3sdk
        submodules: recursive

    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build Beverley CLAP and VST3
      run: cargo run -p xtask -- bundle beverley --release
      env:
        CLAP_WRAPPER_VST3_SDK: ${{ github.workspace }}/vst3sdk

    - name: Create Windows ZIP archive
      run: |
        mkdir -p release
        cp -r target/bundled/beverley.clap release/
        cp -r target/bundled/beverley.vst3 release/
        cp LICENSE release/
        cp THIRD-PARTY-LICENSES.md release/
      shell: bash

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: beverley-windows
        path: release/
        if-no-files-found: error

  build-macos-arm64:
    name: Build macOS ARM64 CLAP and VST3
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: aarch64-apple-darwin

    - name: Checkout VST3 SDK
      uses: actions/checkout@v4
      with:
        repository: steinbergmedia/vst3sdk
        path: vst3sdk
        submodules: recursive

    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-arm64-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-arm64-cargo-

    - name: Build Beverley CLAP and VST3 for ARM64
      run: cargo run -p xtask -- bundle beverley --release --target aarch64-apple-darwin
      env:
        CLAP_WRAPPER_VST3_SDK: ${{ github.workspace }}/vst3sdk

    - name: Create macOS ZIP archive
      run: |
        mkdir -p release
        cp -r target/bundled/beverley.clap release/
        cp -r target/bundled/beverley.vst3 release/
        cp LICENSE release/
        cp THIRD-PARTY-LICENSES.md release/

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: beverley-macos-arm64
        path: release/
        if-no-files-found: error

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos-arm64]
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create ZIP archives
      run: |
        cd beverley-windows
        zip -r ../beverley-${{ github.ref_name }}-windows.zip *
        cd ../beverley-macos-arm64
        zip -r ../beverley-${{ github.ref_name }}-macos-arm64.zip *
        cd ..

    - name: Extract version from tag
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Generate release notes
      id: release_notes
      run: |
        cat << EOF > release_notes.md
        # Beverley ${{ github.ref_name }}

        Advanced bitcrusher and harmonic distortion audio plugin.

        ## Downloads

        - **Windows**: \`beverley-${{ github.ref_name }}-windows.zip\`
        - **macOS ARM64** (Apple Silicon): \`beverley-${{ github.ref_name }}-macos-arm64.zip\`

        ## Installation

        ### Windows
        1. Extract the ZIP file
        2. Copy \`beverley.clap\` to: \`C:\Program Files\Common Files\CLAP\`
        3. Copy \`beverley.vst3\` to: \`C:\Program Files\Common Files\VST3\`

        ### macOS
        1. Extract the ZIP file
        2. Copy \`beverley.clap\` to: \`~/Library/Audio/Plug-Ins/CLAP/\`
        3. Copy \`beverley.vst3\` to: \`~/Library/Audio/Plug-Ins/VST3/\`

        ## What's Included

        Each download contains:
        - CLAP plugin (\`.clap\`)
        - VST3 plugin (\`.vst3\`)
        - LICENSE file (MIT)
        - THIRD-PARTY-LICENSES.md (dependencies)

        ## License

        This software is released under the MIT License.
        See LICENSE file for details.

        ---

        Built with ❤️ by Vulpus Labs
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Beverley ${{ github.ref_name }}
        body_path: release_notes.md
        files: |
          beverley-${{ github.ref_name }}-windows.zip
          beverley-${{ github.ref_name }}-macos-arm64.zip
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
